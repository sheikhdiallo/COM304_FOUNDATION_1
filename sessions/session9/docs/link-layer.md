[Main Menu](../../README.md) | [session9](../../session9/) | [Link Layer](../docs/link-layer.md)

# Link Layer

The link layer is used for local point to point communications where the communicating devices send signals directly between each other over a physical medium.

All digital network communication is performed by sending a series of bits serially as binary `1` or `0` symbols in a series of `frames` 
The `link layer` translates these signals into a form which can be transmitted across a `medium` which could be cable (RS232/Ethernet/ADSL), Air (wireless/wifi) or light (fibre).

#### RS232 Serial Point to Point
One of the earliest and simplest link layer protocols (called [RS232](https://en.wikipedia.org/wiki/RS-232)) uses a serial cable between the two devices. 
This might connect a computer to a [dial up modem](https://en.wikipedia.org/wiki/Dial-up_Internet_access) or a [serial terminal](https://en.wikipedia.org/wiki/Computer_terminal).

Earlier we played with a simulated UART to print characters to a serial terminal.
A UART will typically enable RS232 communication.

A UART is a very simple link layer device where each frame contains is a single byte of data. 

![alt text](../docs/images/05_Understanding-UART_02_w640_hX.png "05_Understanding-UART_02_w640_hX.png")

The frame has `start` and `stop` bits and includes a single bit `parity checksum` which checks if there are an odd or even number of 1's in the data byte.
When the frame is received, the checksum is recalculated and if the bit doesn't match, the frame is discarded.
See [how a UART works](https://www.rohde-schwarz.com/uk/products/test-and-measurement/essentials-test-equipment/digital-oscilloscopes/understanding-uart_254524.html)

#### Ethernet

Normally RS232 can only connect two devices but later link layer protocols can connect multiple devices on the same `network segment`.

[Ethernet](https://en.wikipedia.org/wiki/Ethernet) is a widely used standard where all of the devices in the same segment listen to all of the messages transmitted to the segment and select only the messages which are addressed to themselves.

The Ethernet frame format is shown below

![alt text](../docs/images/Ethernet_Type_II_Frame_format.svg.png "Ethernet_Type_II_Frame_format.svg.png")

Early Ethernet networks used a single co-axial cable ([10bse5](https://www.mattmillman.com/projects/10base5/)) to connect all of the devices in the same segment.
Devices could send messages at at any time so it was possible that two devices would send at the same time and the messages would collide. 
(Hence another name for the Ethernet protocol was `CSMA-CD - Carrier Sense Multiple Access - Collision Detect`)
However provided the network was less than 30% occupied, most of the messages would get through.

Today, most Ethernet networks use separate [Category 5 twisted pair cables](https://en.wikipedia.org/wiki/Category_5_cable) to connect each of the devices to a  common`layer 2 switch` or `hub`.
Unlike a passive coaxial cable, the switch is a single point of failure but it can increase throughput by buffering frames to avoid collisions.

![alt text](../docs/images/GS724T_large1.jpg "GS724T_large1.jpg")
![alt text](../docs/images/smallSwitch.jpg "smallSwitch.jpg")

Ethernet uses a `Media Access Control (MAC) Protocol` which describes the messages sent on an Ethernet segment.
The MAC protocol describes a link layer frame of up to 1518 bytes. 

Every device on an Ethernet segment has network ports implemented by (Network Interface Cards (NICs).
Each NIC has a unique `Media Access Control (MAC) address` which is used by the receiving device to tell whether the message is for itself.
The `MAC Address` is often set by the NIC manufacturer and should be globally unique or at least unique within the segment.

When a device transmits a frame, it includes its own MAC address, the `source MAC address`, and the `destination MAC address` of the device it wants to talk to.

The frame also contains up to 1500 bytes of data and a 4 byte `checksum`.
The `checksum` is calculated by the transmitter using an algorithm which scans all of the data bytes in the frame. 
When a frame is received, the receiver also calculates the checksum and if the received checksum doesn't match the transmitted checksum, there is an error in transmission and the whole frame is discarded.

Frames generated by the `network layer` form the `payload` of `link layer frames`. 
Sometimes the network layer frames (or `packets`) are too big for the link layer, in which case they are `fragmented` and joined back to together by the link layer.

#### Address Resolution

We have seen that every NIC connected to a `link layer` segment has a fixed `MAC address` for each of its ports.
This uniquely identifies the physical device.

To communicate through the `network layer`, each device device is also given an IP address.

The [Address Resolution Protocol (ARP)](https://en.wikipedia.org/wiki/Address_Resolution_Protocol) is used to allow  devices to discover what other devices are in their segment and what their IP addresses are. 
When a host wants to send a packet to another host, say to IP address 10.5.5.1, on its local area network (LAN), it first sends out (broadcasts) an ARP packet. The ARP packet contains a simple question: What is the MAC address corresponding to IP address 10.5.5.1? The host that has been configured to use the IP address responds with an ARP packet containing its MAC address.
This allows the device to build up an `ARP Table` which maps IP addresses reachable on the local network to the associated MAC Address of the NIC.

#### Exercise - look at the ARP tables for your device

On windows, open a power shell and type `arp -a`

```
PS C:\Users\cg02r> arp -a

Interface: 192.168.10.101 --- 0x12
  Internet Address      Physical Address      Type
  192.168.10.1          00-14-d1-57-11-ad     dynamic
  192.168.10.102        b8-27-eb-5b-24-76     dynamic
  192.168.10.255        ff-ff-ff-ff-ff-ff     static
  224.0.0.22            01-00-5e-00-00-16     static
  224.0.0.251           01-00-5e-00-00-fb     static
  224.0.0.252           01-00-5e-00-00-fc     static
  239.192.152.143       01-00-5e-40-98-8f     static
  239.255.255.250       01-00-5e-7f-ff-fa     static
  255.255.255.255       ff-ff-ff-ff-ff-ff     static
```

On a Raspberry pi try `arp -a` or `arp`

```
admin@raspberrypi01:~ $ arp -a
wstaff-79-128-1.solent.ac.uk (10.79.128.1) at b4:0c:25:e2:80:10 [ether] on wlan0
192-168-x-x.solent.ac.uk (192.168.10.1) at 00:14:d1:57:11:ad [ether] on eth0
192-168-x-x.solent.ac.uk (192.168.10.101) at 34:48:ed:03:cc:73 [ether] on eth0
```

```
admin@raspberrypi01:~ $ arp
Address                  HWtype  HWaddress           Flags Mask            Iface
wstaff-79-128-1.solent.  ether   b4:0c:25:e2:80:10   C                     wlan0
192-168-x-x.solent.ac.u  ether   00:14:d1:57:11:ad   C                     eth0
192-168-x-x.solent.ac.u  ether   34:48:ed:03:cc:73   C                     eth0

```

#### Address Allocation (DHCP)

Devices can be manually allocated `static IP addresses`, but it usually more convenient to automatically allocate an IP address to a device when it is first connected to the network.
This is done using the [Dynamic Host Configuration Protocol (DHCP)](https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol).

When a device connects to the network, it broadcasts a `DHCP Request` and any `DHCP Server` on the network will supply the device with the next available IP address from the pool of DHCP addresses. 

An address is only `leased` for a period of time to the device so that if it disappears, the address can be reallocated and the DHCP address pool is not exhausted.
